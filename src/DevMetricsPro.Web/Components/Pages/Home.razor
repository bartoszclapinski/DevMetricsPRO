@page "/"
@using DevMetricsPro.Web.Services
@inject AuthStateService AuthState
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<Home> Logger
@inject ISnackbar Snackbar

<PageTitle>Dashboard - DevMetrics Pro</PageTitle>

@if (!_isAuthenticated)
{
    <div style="text-align: center; padding: 60px 20px;">
        <h1 style="font-size: 32px; margin-bottom: 16px; color: var(--text-primary);">Welcome to DevMetrics Pro</h1>
        <p style="font-size: 16px; margin-bottom: 24px; color: var(--text-secondary);">
            A real-time developer analytics platform for tracking team productivity and code quality.
        </p>
        <a href="/login" class="panel-action" style="padding: 12px 24px; font-size: 16px; text-decoration: none; display: inline-block;">
            Get Started
        </a>
    </div>
}
else
{
    <!-- Metrics Grid -->
    <div class="metrics-grid">
        <MetricCard 
            Label="Total Commits" 
            Value="@_totalCommits.ToString("N0")" 
            Change="+12.5% from last week"
            Trend="MetricCard.TrendDirection.Up" />
        
        <MetricCard 
            Label="Pull Requests" 
            Value="89" 
            Change="+8.3% from last week"
            Trend="MetricCard.TrendDirection.Up" />
        
        <MetricCard 
            Label="Active Developers" 
            Value="24" 
            Change="+2 this month"
            Trend="MetricCard.TrendDirection.Up" />
        
        <MetricCard 
            Label="Code Reviews" 
            Value="156" 
            Change="+15.2% from last week"
            Trend="MetricCard.TrendDirection.Up" />
    </div>

    <!-- Panels Grid -->
    <div class="panel-grid" style="margin-top: 24px;">
        <DataPanel Title="Activity Overview">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-tertiary);">
                <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                <div style="font-size: 14px;">Chart visualization will be implemented in Sprint 3</div>
            </div>
        </DataPanel>

        <DataPanel Title="Recent Activity">
            @if (_recentCommits.Any())
            {
                <DataTable TItem="RecentCommitDto" Items="@_recentCommits">
                    <TableHeader>
                        <th>Commit</th>
                        <th class="text-right">Time</th>
                    </TableHeader>
                    <RowTemplate>
                        <td>
                            <div style="font-size: 13px; color: var(--text-primary); margin-bottom: 2px;">
                                @(context.Message.Length > 40 ? context.Message.Substring(0, 40) + "..." : context.Message)
                            </div>
                            <div class="text-small text-muted">
                                @context.AuthorName in @context.RepositoryName
                            </div>
                        </td>
                        <td class="text-right text-small text-muted">
                            @GetRelativeTime(context.CommittedAt)
                        </td>
                    </RowTemplate>
                </DataTable>
            }
            else
            {
                <div style="text-align: center; padding: 40px 20px; color: var(--text-tertiary);">
                    <div style="font-size: 14px; margin-bottom: 4px;">No commits yet</div>
                    <div style="font-size: 12px;">Sync your repositories to see commits</div>
                </div>
            }
        </DataPanel>
    </div>
}

@if (_isAuthenticated)
{
    <div style="margin-top: 24px; max-width: 600px;">
        <DataPanel Title="GitHub Integration">
            @if (!isGitHubConnected)
            {
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                    Connect your GitHub account to sync repositories and track metrics.
                </p>
                <button class="panel-action" @onclick="ConnectGitHub" disabled="@isConnectingGitHub" 
                        style="padding: 8px 16px; background: var(--text-primary); color: white; cursor: @(isConnectingGitHub ? "not-allowed" : "pointer");">
                    @if (isConnectingGitHub)
                    {
                        <span>Connecting...</span>
                    }
                    else
                    {
                        <span>Connect GitHub</span>
                    }
                </button>
            }
            else
            {
                <div style="padding: 12px; background: rgba(40, 167, 69, 0.1); border-radius: 4px; margin-bottom: 16px;">
                    <div style="color: var(--success); font-size: 14px;">
                        ✓ Connected as <strong>@@@githubUsername</strong>
                    </div>
                </div>
                <p style="font-size: 14px; color: var(--text-secondary);">
                    Your GitHub account is linked and ready to sync.
                </p>
            }
            
            @if (!string.IsNullOrEmpty(githubConnectedMessage))
            {
                <div style="padding: 12px; background: rgba(3, 102, 214, 0.1); border-radius: 4px; margin-top: 16px;">
                    <div style="color: var(--info); font-size: 14px;">@githubConnectedMessage</div>
                </div>
            }
        </DataPanel>
    </div>
}

@code {
    private bool _isAuthenticated = false;
    private int _totalCommits = 0;
    private List<RecentCommitDto> _recentCommits = new();
    private bool isConnectingGitHub = false;
    private bool isGitHubConnected = false;
    private string? githubUsername;
    private string? githubConnectedMessage;

    protected override async Task OnInitializedAsync()
    {
        _isAuthenticated = await AuthState.IsAuthenticatedAsync();
        
        if (_isAuthenticated)
        {
            await CheckGitHubConnectionStatus();
            await LoadRecentCommitsAsync();
        }
        
        // Check if we were redirected back from GitHub OAuth
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (query["github"] == "connected")
        {
            githubConnectedMessage = "GitHub account connected successfully!";
            await CheckGitHubConnectionStatus(); // Refresh status
        }
    }

    private async Task CheckGitHubConnectionStatus()
    {
        try
        {
            var token = await AuthState.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
                return;

            var request = new HttpRequestMessage(HttpMethod.Get, "/api/github/status");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var status = await response.Content.ReadFromJsonAsync<GitHubStatusResponse>();
                if (status?.Connected == true)
                {
                    isGitHubConnected = true;
                    githubUsername = status.Username;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking GitHub connection status");
        }
    }

    private async Task ConnectGitHub()
    {
        isConnectingGitHub = true;
        
        try
        {
            var token = await AuthState.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                Snackbar.Add("Please login first", Severity.Warning);
                return;
            }

            // Create request with Authorization header
            var request = new HttpRequestMessage(HttpMethod.Get, "/api/github/authorize");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GitHubAuthResponse>();
                if (result?.AuthorizationUrl != null)
                {
                    // Redirect to GitHub authorization page
                    Navigation.NavigateTo(result.AuthorizationUrl, forceLoad: true);
                }
            }
            else
            {
                Snackbar.Add("Failed to initiate GitHub connection", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error connecting to GitHub");
            Snackbar.Add("Failed to connect to GitHub. Please try again.", Severity.Error);
        }
        finally
        {
            isConnectingGitHub = false;
        }
    }

    private async Task LoadRecentCommitsAsync()
    {
        try
        {
            var token = await AuthState.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
                return;

            var request = new HttpRequestMessage(HttpMethod.Get, "/api/github/commits/recent?limit=10");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<RecentCommitsResponse>();
                if (result?.Success == true)
                {
                    _totalCommits = result.TotalCommits;
                    _recentCommits = result.Commits ?? new List<RecentCommitDto>();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading recent commits");
        }
    }

    private string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} minutes ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} hours ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)timeSpan.TotalDays} days ago";
        
        return dateTime.ToString("MMM dd, yyyy");
    }

    // Helper classes for deserializing API responses
    private class GitHubAuthResponse
    {
        public string? AuthorizationUrl { get; set; }
    }

    private class GitHubStatusResponse
    {
        public bool Connected { get; set; }
        public string? Username { get; set; }
        public DateTime? ConnectedAt { get; set; }
    }

        private class RecentCommitsResponse
    {
        public bool Success { get; set; }
        public int TotalCommits { get; set; }
        public List<RecentCommitDto>? Commits { get; set; }
    }

    private class RecentCommitDto
    {
        public string Sha { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
        public string AuthorName { get; set; } = string.Empty;
        public DateTime CommittedAt { get; set; }
        public string RepositoryName { get; set; } = string.Empty;
        public int LinesAdded { get; set; }
        public int LinesRemoved { get; set; }
    }
}