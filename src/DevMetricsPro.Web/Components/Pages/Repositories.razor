@page "/repositories"
@using DevMetricsPro.Web.Services
@using DevMetricsPro.Application.DTOs.GitHub
@inject AuthStateService AuthState
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<Repositories> Logger
@inject ISnackbar Snackbar

<PageTitle>Repositories - DevMetrics Pro</PageTitle>

<h1 style="font-size: 24px; margin-bottom: 24px; color: var(--text-primary); font-weight: 600;">My Repositories</h1>

@if (!_isAuthenticated)
{
    <div style="padding: 16px; background: rgba(255, 165, 0, 0.1); border-left: 3px solid var(--warning); border-radius: var(--border-radius);">
        <div style="font-size: 14px; color: var(--text-primary);">
            Please <a href="/login" style="color: var(--info); text-decoration: underline;">login</a> to view your repositories.
        </div>
    </div>
}
else if (!_isGitHubConnected)
{
    <div style="padding: 16px; background: rgba(3, 102, 214, 0.1); border-left: 3px solid var(--info); border-radius: var(--border-radius);">
        <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 12px;">
            You haven't connected your GitHub account yet.
        </div>
        <a href="/" class="panel-action" style="text-decoration: none; display: inline-block;">
            Go to Dashboard to Connect GitHub
        </a>
    </div>
}
else if (_isLoading)
{
    <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
        <div style="font-size: 14px; color: var(--text-tertiary);">Loading repositories...</div>
    </div>
}
else if (!string.IsNullOrEmpty(_errorMessage))
{
    <div style="padding: 16px; background: rgba(215, 58, 73, 0.1); border-left: 3px solid var(--danger); border-radius: var(--border-radius); margin-bottom: 24px;">
        <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 12px;">
            @_errorMessage
        </div>
        <button class="panel-action" @onclick="LoadRepositoriesAsync">
            Retry
        </button>
    </div>
}
else if (_repositories.Count == 0)
{
    <DataPanel Title="No Repositories">
        <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
            <div style="font-size: 16px; margin-bottom: 8px; color: var(--text-primary);">No Repositories Found</div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">
                Click "Sync Now" to fetch your repositories from GitHub.
            </div>
            <button class="panel-action" @onclick="SyncRepositoriesAsync" disabled="@_isSyncing" 
                    style="padding: 8px 16px; background: var(--info); color: white;">
                @if (_isSyncing)
                {
                    <span>Syncing...</span>
                }
                else
                {
                    <span>Sync Now</span>
                }
            </button>
        </div>
    </DataPanel>
}
else
{
    <!-- Header with Sync Button -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div style="font-size: 14px; color: var(--text-secondary);">
            @_repositories.Count repositories
            @if (_lastSyncTime.HasValue)
            {
                <span> ‚Ä¢ Last synced @GetRelativeTime(_lastSyncTime.Value)</span>
            }
        </div>
        <button class="panel-action" @onclick="SyncRepositoriesAsync" disabled="@_isSyncing" 
                style="padding: 8px 16px; background: var(--info); color: white;">
            @if (_isSyncing)
            {
                <span>Syncing...</span>
            }
            else
            {
                <span>‚ü≥ Sync Now</span>
            }
        </button>
    </div>

    <!-- Repository Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
        @foreach (var repo in _repositories)
        {
            <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
                <div style="padding: 16px; flex: 1;">
                    <!-- Repository Name -->
                    <a href="@repo.HtmlUrl" target="_blank" style="color: var(--info); text-decoration: none; font-size: 16px; font-weight: 600; display: block; margin-bottom: 8px;">
                        @repo.Name
                    </a>

                    <!-- Description -->
                    @if (!string.IsNullOrEmpty(repo.Description))
                    {
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; min-height: 40px;">
                            @(repo.Description.Length > 100 ? repo.Description.Substring(0, 100) + "..." : repo.Description)
                        </div>
                    }
                    else
                    {
                        <div style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 12px; min-height: 40px; font-style: italic;">
                            No description provided
                        </div>
                    }

                    <!-- Language Badge -->
                    @if (!string.IsNullOrEmpty(repo.Language))
                    {
                        <StatusBadge Text="@repo.Language" Type="StatusBadge.StatusType.Info" />
                    }

                    <!-- Stats -->
                    <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 12px; color: var(--text-tertiary);">
                        <div>‚≠ê @repo.StargazersCount</div>
                        <div>üî± @repo.ForksCount</div>
                        <div>üêõ @repo.OpenIssuesCount</div>
                    </div>

                    <!-- Badges -->
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        @if (repo.IsPrivate)
                        {
                            <StatusBadge Text="Private" Type="StatusBadge.StatusType.Warning" />
                        }
                        @if (repo.IsFork)
                        {
                            <StatusBadge Text="Fork" Type="StatusBadge.StatusType.Info" />
                        }
                    </div>

                    <!-- Last Updated -->
                    @if (repo.PushedAt.HasValue)
                    {
                        <div class="text-small text-muted" style="margin-top: 12px;">
                            Updated @GetRelativeTime(repo.PushedAt.Value)
                        </div>
                    }
                </div>
                
                <!-- Action Footer -->
                <div style="padding: 12px 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: var(--text-tertiary);">
                        @if (_repositoryCommitCounts.ContainsKey(repo.Id))
                        {
                            <span>@_repositoryCommitCounts[repo.Id] commits</span>
                        }
                        else
                        {
                            <span>No commits synced</span>
                        }
                    </div>
                    <button class="panel-action" 
                            @onclick="() => SyncCommitsAsync(repo.Id, repo.Name)" 
                            disabled="@(_syncingRepositoryId == repo.Id)"
                            style="padding: 6px 12px; font-size: 12px;">
                        @if (_syncingRepositoryId == repo.Id)
                        {
                            <span>Syncing...</span>
                        }
                        else
                        {
                            <span>‚ü≥ Sync Commits</span>
                        }
                    </button>
                </div>
            </div>
        }
    </div>
}

@code {
    private bool _isAuthenticated = false;
    private bool _isGitHubConnected = false;
    private bool _isLoading = true;
    private bool _isSyncing = false;
    private string? _errorMessage;
    private DateTime? _lastSyncTime;
    private List<GitHubRepositoryDto> _repositories = new();
    private long? _syncingRepositoryId = null;
    private Dictionary<long, int> _repositoryCommitCounts = new();

    protected override async Task OnInitializedAsync()
    {
        _isAuthenticated = await AuthState.IsAuthenticatedAsync();
        
        if (_isAuthenticated)
        {
            await CheckGitHubConnectionAsync();
            
            if (_isGitHubConnected)
            {
                await LoadRepositoriesAsync();
            }
        }
        
        _isLoading = false;
    }

    private async Task CheckGitHubConnectionAsync()
    {
        try
        {
            var token = await AuthState.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
                return;

            var request = new HttpRequestMessage(HttpMethod.Get, "/api/github/status");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var status = await response.Content.ReadFromJsonAsync<GitHubStatusResponse>();
                _isGitHubConnected = status?.Connected == true;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking GitHub connection status");
        }
    }

    private async Task LoadRepositoriesAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        
        try
        {
            var token = await AuthState.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Post, "/api/github/sync-repositories");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            
            var response = await Http.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SyncRepositoriesResponse>();
                if (result?.Success == true && result.Repositories != null)
                {
                    _repositories = result.Repositories.OrderByDescending(r => r.StargazersCount).ToList();
                    _lastSyncTime = DateTime.UtcNow;
                    Logger.LogInformation("Loaded {Count} repositories", _repositories.Count);
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                Navigation.NavigateTo("/login");
            }
            else
            {
                _errorMessage = "Failed to load repositories. Please try again.";
                Logger.LogError("Failed to load repositories. Status: {StatusCode}", response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading repositories");
            _errorMessage = "An error occurred while loading repositories.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SyncRepositoriesAsync()
    {
        _isSyncing = true;
        
        try
        {
            await LoadRepositoriesAsync();
            
            if (string.IsNullOrEmpty(_errorMessage))
            {
                Snackbar.Add($"Successfully synced {_repositories.Count} repositories!", Severity.Success);
            }
        }
        finally
        {
            _isSyncing = false;
        }
    }

    private async Task SyncCommitsAsync(long repositoryId, string repositoryName)
    {
        _syncingRepositoryId = repositoryId;
        
        try
        {
            var token = await AuthState.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                Snackbar.Add("Authentication required", Severity.Warning);
                return;
            }

            var request = new HttpRequestMessage(HttpMethod.Post, $"/api/github/commits/sync/{repositoryId}");
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            
            var response = await Http.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SyncCommitsResponse>();
                if (result?.Success == true)
                {
                    _repositoryCommitCounts[repositoryId] = result.AddedCount + result.UpdatedCount;
                    Snackbar.Add($"Synced {result.AddedCount + result.UpdatedCount} commits for {repositoryName}", Severity.Success);
                    Logger.LogInformation("Synced {Count} commits for repository {Name}", result.AddedCount + result.UpdatedCount, repositoryName);
                }
            }
            else
            {
                var errorMessage = $"Failed to sync commits for {repositoryName}";
                Snackbar.Add(errorMessage, Severity.Error);
                Logger.LogError("Failed to sync commits for repository {Name}. Status: {StatusCode}", repositoryName, response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error syncing commits for repository {Name}", repositoryName);
            Snackbar.Add($"Error syncing commits for {repositoryName}", Severity.Error);
        }
        finally
        {
            _syncingRepositoryId = null;
        }
    }

    private string GetRelativeTime(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        if (timeSpan.TotalMinutes < 1)
            return "just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} minutes ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} hours ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)timeSpan.TotalDays} days ago";
        if (timeSpan.TotalDays < 365)
            return $"{(int)(timeSpan.TotalDays / 30)} months ago";
        
        return $"{(int)(timeSpan.TotalDays / 365)} years ago";
    }

    // Response wrapper classes specific to this UI
    private class SyncRepositoriesResponse
    {
        public bool Success { get; set; }
        public int Count { get; set; }
        public List<GitHubRepositoryDto>? Repositories { get; set; }
    }

    private class GitHubStatusResponse
    {
        public bool Connected { get; set; }
        public string? Username { get; set; }
    }

    private class SyncCommitsResponse
    {
        public bool Success { get; set; }
        public int AddedCount { get; set; }
        public int UpdatedCount { get; set; }
    }
}