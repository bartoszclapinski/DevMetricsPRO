@inherits LayoutComponentBase
@using DevMetricsPro.Web.Services
@inject AuthStateService AuthState
@inject NavigationManager Navigation
@implements IDisposable

<!-- Keep MudBlazor providers for forms, dialogs, and snackbars -->
<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<!-- New custom layout with design system -->
<TopNav IsAuthenticated="_isAuthenticated" 
        UserEmail="_userEmail" 
        OnLogout="HandleLogout" />

@if (_isAuthenticated && _showControlPanel)
{
    <ControlPanel Repositories="_repositories"
                  SelectedRepository="_selectedRepository"
                  SelectedTeam="_selectedTeam"
                  SelectedTimeRange="_selectedTimeRange"
                  OnRepositoryChanged="HandleRepositoryChanged"
                  OnTeamChanged="HandleTeamChanged"
                  OnTimeRangeChanged="HandleTimeRangeChanged"
                  OnExportCSV="HandleExportCSV"
                  OnSettings="HandleSettings" />
}

<div class="dashboard-container">
    @Body
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool _isAuthenticated = false;
    private string _userEmail = string.Empty;
    private bool _showControlPanel = true; // Show control panel on authenticated pages
    
    // Control panel state
    private List<string> _repositories = new();
    private string _selectedRepository = string.Empty;
    private string _selectedTeam = string.Empty;
    private string _selectedTimeRange = "7D";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Wait for JavaScript to be ready
            await Task.Delay(100);
            
            // Subscribe to navigation changes to refresh auth state
            Navigation.LocationChanged += OnLocationChanged;
            
            await LoadAuthState();
            StateHasChanged();
        }
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Re-check auth state whenever navigation happens
        await LoadAuthState();
        
        // Hide control panel on login/register pages
        var currentPath = new Uri(Navigation.Uri).AbsolutePath.ToLower();
        _showControlPanel = !currentPath.Contains("/login") && !currentPath.Contains("/register");
        
        StateHasChanged();
    }

    private async Task LoadAuthState()
    {
        try
        {
            _isAuthenticated = await AuthState.IsAuthenticatedAsync();
            
            if (_isAuthenticated)
            {
                var userInfo = await AuthState.GetUserInfoAsync();
                _userEmail = userInfo?.Email ?? "";
            }
            else
            {
                _userEmail = string.Empty;
            }
        }
        catch (Exception)
        {
            // JS not ready or error
            _isAuthenticated = false;
        }
    }

    private async Task HandleLogout()
    {
        await AuthState.RemoveTokenAsync();
        _isAuthenticated = false;
        _userEmail = string.Empty;
        StateHasChanged();
        Navigation.NavigateTo("/login");
    }
    
    // Control panel event handlers
    private Task HandleRepositoryChanged(string repository)
    {
        _selectedRepository = repository;
        // Future enhancement: Filter data by repository
        return Task.CompletedTask;
    }
    
    private Task HandleTeamChanged(string team)
    {
        _selectedTeam = team;
        // Future enhancement: Filter data by team
        return Task.CompletedTask;
    }
    
    private Task HandleTimeRangeChanged(string timeRange)
    {
        _selectedTimeRange = timeRange;
        // Future enhancement: Filter data by time range
        return Task.CompletedTask;
    }
    
    private Task HandleExportCSV()
    {
        // Future enhancement: Implement CSV export functionality
        return Task.CompletedTask;
    }
    
    private Task HandleSettings()
    {
        Navigation.NavigateTo("/settings");
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        // Unsubscribe from navigation changes
        Navigation.LocationChanged -= OnLocationChanged;
    }
}